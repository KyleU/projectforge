{% import (
  "projectforge.dev/projectforge/app"
  "projectforge.dev/projectforge/app/git"
  "projectforge.dev/projectforge/app/controller/cutil"
  "projectforge.dev/projectforge/views/components"
  "projectforge.dev/projectforge/views/layout"
) %}

{% code type Result struct {
  layout.Basic
  Action *git.Action
  Result *git.Result
} %}

{% func (p *Result) Body(as *app.State, ps *cutil.PageState) %}
  {%- code prj := p.Result.Project -%}
  <div class="card">
    <div class="right"><em>{%s p.Result.Status %}</em></div>
    <h3>
      <a href="/p/{%s prj.Key %}">{%= components.SVGRefIcon(prj.IconSafe(), ps) %} {%s prj.Title() %}</a>: Git {%s p.Action.Title %}
      {%- if p.Result.Branch() != "" -%}
      <em>({%s p.Result.Branch() %})</em>
      {%- endif -%}
    </h3>
    <div class="mt">
      {%= statusActions(p.Result) %}
    </div>
    {%= statusDetail(p.Result) %}
  </div>
{% endfunc %}

{% func statusActions(r *git.Result) %}
  {%- code prj := r.Project -%}
  {%- for _, t := range r.Actions() -%}
  <a href="/git/{%s prj.Key %}/{%s t.Key %}" title="{%s t.Description %}"><button>{%s t.Title %}</button></a>
  {%- endfor -%}
{% endfunc %}

{% func statusDetail(r *git.Result) %}
  <table class="mt min-200">
    <tbody>
      <tr>
        <th class="shrink">Status</th>
        <td>{%s r.Status %}</td>
      </tr>
      <tr>
        <th class="shrink">Branch</th>
        <td>{%s r.Branch() %}</td>
      </tr>
      {%- if r.CommitMessage() != "" -%}
      <tr>
        <th class="shrink">Commit Message</th>
        <td>{%s r.CommitMessage() %}</td>
      </tr>
      {%- endif -%}
      <tr>
        <th class="shrink">Dirty Files</th>
        <td>{%d len(r.Dirty()) %}</td>
      </tr>
      {%- if len(r.Logs()) > 0 -%}
      <tr>
        <th class="shrink">Logs</th>
        <td>
          <table>
            <tbody>
              {%- for _, l := range r.Logs() -%}
              <tr><td>{%s l %}</td></tr>
              {%- endfor -%}
            </tbody>
          </table>
        </td>
      </tr>
      {%- endif -%}
      <tr>
        <th class="shrink">Data</th>
        <td>{%= components.JSON(r.Data) %}</td>
      </tr>
    </tbody>
  </table>
{% endfunc %}
