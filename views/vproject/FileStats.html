{% import (
  "path/filepath"

  "golang.org/x/exp/slices"

  "projectforge.dev/projectforge/app"
  "projectforge.dev/projectforge/app/controller/cutil"
  "projectforge.dev/projectforge/app/project"
  "projectforge.dev/projectforge/app/project/stats"
  "projectforge.dev/projectforge/app/util"
  "projectforge.dev/projectforge/views/components"
  "projectforge.dev/projectforge/views/layout"
) %}

{% code type FileStats struct {
  layout.Basic
  Project *project.Project
  Path []string
  Files stats.FileStats
} %}

{% func (p *FileStats) Body(as *app.State, ps *cutil.PageState) %}
  {%- code prj := p.Project -%}
  {%= Summary(prj, nil, nil, nil, ps) %}
  <div class="card">
    <div class="right"><a href="#modal-stats"><button type="button">JSON</button></a></div>
    <h3>File Statistics</h3>
    <h3><a href="?">.</a>{%- for idx, px := range p.Path -%}/<a href="?dir={%u filepath.Join(p.Path[:idx + 1]...) %}">{%s px %}</a>{%- endfor -%}</h3>
    {%- if len(p.Files) == 0 -%}
    <p><em>No files available</em></p>
    {%- else -%}
    <ul class="accordion">
    {%- for _, f := range p.Files -%}
      {%= renderFileStat(p.Path, f, as, ps) %}
    {%- endfor -%}
    </ul>
    {%- endif -%}
  </div>
  {%= components.JSONModal("stats", "File Stats JSON", p.Files, 1) %}
{% endfunc %}

{% func renderFileStat(pth []string, f *stats.FileStat, as *app.State, ps *cutil.PageState) %}
  <li>
    <input id="accordion-{%s f.FullPath() %}" type="checkbox" hidden />
    <label for="accordion-{%s f.FullPath() %}">{%= renderFileStatSummary(f, ps) %}</label>
    <div class="bd">
      {%- if len(f.Kids) > 0 -%}
      <ul class="accordion">
        {%- for _, k := range f.Kids -%}
        {%= renderFileStat(append(slices.Clone(pth), f.Name), k, as, ps) %}
        {%- endfor -%}
      </ul>
    </div>
    {% endif %}
  </li>
{% endfunc %}

{% func renderFileStatSummary(f *stats.FileStat, ps *cutil.PageState) %}{% stripspace %}
  {% code
    icon := "file"
    if f.IsDir {
      icon = "folder"
    }
    sz := f.TotalSize()
    status := util.ByteSizeSI(sz)
  %}
  {%= components.ExpandCollapse(3, ps) %}
  <div class="right"><em>{%s status %}</em></div>
  {%= components.SVGRef(icon, 16, 16, `icon`, ps) %}
  {% if f.IsDir %}
    <a href="?dir={%u f.FullPath() %}">
  {% endif %}
  {%s f.Name %}
  {% if f.IsDir %}
    </a>
  {% endif %}
{% endstripspace %}{% endfunc %}
