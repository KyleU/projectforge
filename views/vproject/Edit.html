{% import (
  "strings"
  "github.com/kyleu/projectforge/app"
  "github.com/kyleu/projectforge/app/controller/cutil"
  "github.com/kyleu/projectforge/app/project"
  "github.com/kyleu/projectforge/app/theme"
  "github.com/kyleu/projectforge/app/util"
  "github.com/kyleu/projectforge/views/components"
  "github.com/kyleu/projectforge/views/layout"
  "github.com/kyleu/projectforge/views/vtheme"
) %}

{% code type Edit struct {
  layout.Basic
  Project *project.Project
} %}

{% func (p *Edit) Body(as *app.State, ps *cutil.PageState) %}
  {%- code prj := p.Project -%}
  {%- if prj.Info == nil -%}
  <div class="card">
    <h3>Project Not Initialized!</h3>
    <p>TODO: explain initialization</p>
  </div>
  {%- endif -%}
  {%- code
    info := prj.Info
    if info == nil {
      info = &project.Info{}
    }
    build := prj.Build
    if build == nil {
      build = &project.Build{}
    }
    buildMap := build.ToMap()
  -%}
  <form action="" method="post">
    <div class="card">
      <h3>Project Details</h3>
      <table class="mt min-200">
        <tbody>
        {%- if prj.Key == "" -%}
        {%= components.TableInput("key", "Key", prj.Key, 5) %}
        {%- endif -%}
        {%= components.TableInput("name", "Name", strings.TrimSuffix(prj.Name, " (missing)"), 5) %}
        {%= components.TableInput("icon", "Icon", prj.Icon, 5) %}
        {%= components.TableInput("version", "Version", prj.Version, 5) %}
        {%= components.TableInput("package", "Package", prj.Package, 5) %}
        {%= components.TableInput("args", "Args", prj.Args, 5) %}
        {%= components.TableInputNumber("port", "Port", prj.Port, 5) %}
        <tr>
          <th class="shrink">Modules</th>
          <td>
            {%- for _, mod := range as.Services.Modules.Modules() -%}
            <label title="{%s mod.Description %}">
              {%- if util.StringArrayContains(prj.Modules, mod.Key) -%}
              <input type="checkbox" name="modules" value="{%s mod.Key %}" checked="checked"/>
              {%- else -%}
              <input type="checkbox" name="modules" value="{%s mod.Key %}"/>
              {%- endif -%}
              {%s mod.Title() %}
            </label>
            {%- endfor -%}
          </td>
        </tr>
        {%= components.TableInput("ignore", "Ignore", strings.Join(prj.Ignore, ", "), 5) %}
        {%= components.TableTextarea("children", "Children", len(prj.Children), strings.Join(prj.Children, "\n"), 5) %}
        {%= components.TableInput("path", "Path", prj.Path, 5) %}
        </tbody>
      </table>
    </div>
    <div class="card">
      <h3>Metadata</h3>
      <table class="mt min-200">
        <tbody>
        {%= components.TableInput("org", "Organization", info.Org, 5) %}
        {%= components.TableInput("authorName", "Author Name", info.AuthorName, 5) %}
        {%= components.TableInput("authorEmail", "Author Email", info.AuthorEmail, 5) %}
        {%= components.TableInput("license", "License", info.License, 5) %}
        {%= components.TableInput("bundle", "Bundle", info.Bundle, 5) %}
        {%= components.TableInput("signingIdentity", "Signing Identity", info.SigningIdentity, 5) %}
        {%= components.TableInput("homepage", "Homepage", info.Homepage, 5) %}
        {%= components.TableInput("sourcecode", "Source Code", info.Sourcecode, 5) %}
        {%= components.TableInput("summary", "Summary", info.Summary, 5) %}
        {%= components.TableTextarea("description", "Description", 8, info.Description, 5) %}
        </tbody>
      </table>
    </div>
    {%- code
      t := prj.Theme
      if t == nil {
        t = theme.ThemeDefault
      }
    -%}
    {%= vtheme.Editor(prj.Title(), t, as, ps) %}
    <div class="card">
      <h3>Builds</h3>
      <table class="mt min-200">
        <tbody>
        {%- for _, o := range project.AllBuildOptions -%}
        <tr>
          <th class="shrink">{%s o.Title %}</th>
          <td><label><input type="checkbox" name="build-{%s o.Key %}" value="true" {% if buildMap[o.Key] %} checked="checked" {% endif %}/> {%s o.Description %}</label></td>
        </tr>
        {%- endfor -%}
        </tbody>
      </table>
    </div>
    <div class="card">
      <button type="submit">Save</button>
      <button type="reset">Reset</button>
    </div>
  </form>
{% endfunc %}
