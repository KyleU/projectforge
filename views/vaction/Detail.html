{% import (
  "strings"

  "github.com/kyleu/projectforge/app"
  "github.com/kyleu/projectforge/app/controller/cutil"
  "github.com/kyleu/projectforge/app/action"
  "github.com/kyleu/projectforge/app/util"
) %}

{% func Detail(cfg util.ValueMap, res *action.Result, includeSkipped bool, as *app.State, ps *cutil.PageState) %}
  <div class="card">
    <h3>Config</h3>
    <table>
      <tbody>
        {%- for _, k := range cfg.Keys() -%}
        <tr>
          <th class="shrink">{%s k %}</th>
          <td>{%v cfg[k] %}</td>
        </tr>
        {%- endfor -%}
      </tbody>
    </table>
  </div>
  {%- if len(res.Errors) > 0 -%}
  <div class="card">
    <h3>Errors</h3>
    <table>
      <tbody>
        {%- for _, e := range res.Errors -%}
        <tr>
          <td>{%s e %}</td>
        </tr>
        {%- endfor -%}
      </tbody>
    </table>
  </div>
  {%- endif -%}
  {%- if len(res.Logs) > 0 -%}
  <div class="card">
    <h3>Logs</h3>
    <table>
      <tbody>
        {%- for _, l := range res.Logs -%}
        <tr>
          <td><pre>{%s l %}</pre></td>
        </tr>
        {%- endfor -%}
      </tbody>
    </table>
  </div>
  {%- endif -%}
  {%- for _, mr := range res.Modules -%}
    {%- code
      links := ""
      for mIdx, mk := range mr.Keys {
        if mIdx > 0 {
          links += ", "
        }
        links += `<a href="/m/` + mk + `">` + mk + `</a>`
      }
    -%}
    <div class="card">
      <div class="right">{%s util.MicrosToMillis(mr.Duration) %}</div>
      <h3>{%s util.PluralMaybe("Module", len(mr.Keys)) %} [{%s= links %}]</h3>
      <div class="right"><em>{%s res.StatusLog() %}</em></div>
      <em>{%s mr.Status %}</em>
      {%- if len(mr.Actions) > 0 -%}
      <h4>Actions</h4>
      {%- for _, a := range mr.Actions -%}
        <a href="{%s a.URL() %}"><button>{%s a.Title %}</button></a>
      {%- endfor -%}
      {%- endif -%}
      {%- code diffs := mr.DiffsFiltered(includeSkipped) -%}
      {%- if len(diffs) > 0 -%}
      <h4>Diffs</h4>
      <table>
        <thead>
          <tr>
            <th class="shrink">Path</th>
            <th class="shrink">Status</th>
            <th class="shrink">Patch</th>
          </tr>
        </thead>
        <tbody>
        {%- for _, d := range diffs -%}
          <tr>
            <td class="shrink">{%s d.Path %}</td>
            <td>{%s d.Status.String() %}</td>
            <td>{%= renderPatch(d.Patch, as, ps) %}</td>
          </tr>
        {%- endfor -%}
        </tbody>
      </table>
      {%- endif -%}
    </div>
  {%- endfor -%}
{% endfunc %}

{% func renderPatch(patch string, as *app.State, ps *cutil.PageState) %}{% stripspace %}
  {% code lines := strings.Split(patch, "\n") %}
  <pre>
    {% for _, line := range lines %}
      {% if len(line) > 0 %}
        {% switch line[0] %}
        {% case ' ' %}
        <div style="color: grey;">{%s line[1:] %}</div>
        {% case '+' %}
        <div style="color: green;">{%s line[1:] %}{% if len(line) == 1 %}&nbsp;{% endif %}</div>
        {% case '-' %}
        <div style="color: red;">{%s line[1:] %}{% if len(line) == 1 %}&nbsp;{% endif %}</div>
        {% default %}
        {%s line %}
        {% endswitch %}
      {% endif %}
    {% endfor %}
  </pre>
{% endstripspace %}{% endfunc %}
